<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Map</title>
    <link rel="stylesheet" type="text/css" href="style.css" />

    <!-- MOVE TO STYLE.CSS FILE -->
    <!-- MOVE TO STYLE.CSS FILE -->
    <!-- MOVE TO STYLE.CSS FILE -->
    <style>
      #map {
        height: 400px;
        width: 80%;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <!-- MOVE TO STYLE.CSS FILE -->
    <!-- MOVE TO STYLE.CSS FILE -->
    <!-- MOVE TO STYLE.CSS FILE -->

    <script
      src="https://code.jquery.com/jquery-3.4.1.js"
      integrity="sha384-mlceH9HlqLp7GMKHrj5Ara1+LvdTZVMx4S1U43/NxCvAkzIo8WJ0FE7duLel3wVo"
      crossorigin="anonymous"
    ></script>

    <!-- Loads the map from the map.js file -->
    <script>
      var storedLat = parseFloat(localStorage.getItem("latitude"));
      var storedLong = parseFloat(localStorage.getItem("longitude"));
      var businesses = [];

      var token =
        "Bearer p5bQJH1HPyIfJCSGlFS22FkYCWiRiDR1rQEDEfr8_MZUlzrOo4i3CEc8qVDdTdXbk1DmHJdnfuErzo4vuoS1_4tGvZB-augVp9Lg6jGaa9uV-BlBkNzho4QQP7ZRXnYx";
      var cors_anywhere = "https://cors-anywhere.herokuapp.com";
      var yelp_search = "https://api.yelp.com/v3/businesses/search";
      function clientCallback() {
        console.log("Made it to the client callback.");
      }
      var requestObj = {
        async: false,
        url: cors_anywhere + "/" + yelp_search,
        data: {
          term: "restaurants",
          latitude: localStorage.getItem("latitude"),
          longitude: localStorage.getItem("longitude"),
          radius: 8000,
          limit: 50
        },
        headers: {
          Authorization: token
        },
        error: function(jqXHR, textStatus, errorThrown) {
          console.log(
            "AJAX error, jqXHR = ",
            jqXHR,
            ", textStatus = ",
            textStatus,
            ", errorThrown = ",
            errorThrown
          );
        }
      };
      $.ajax(requestObj).done(function(response) {
        for (var i = 0; i < response.businesses.length; ++i) {
          businesses.push({
            name: response.businesses[i].name,
            lat: response.businesses[i].coordinates.latitude,
            long: response.businesses[i].coordinates.longitude,
            rating: response.businesses[i].rating,
            phone: response.businesses[i].phone,
            dist: response.businesses[i].distance,
            revCt: response.businesses[i].review_count,
            price: response.businesses[i].price
          });
        }
        // Sorts the input array first by rating then by distance
        businesses.sort((obj1, obj2) =>
          obj1.rating > obj2.rating
            ? 1
            : obj1.rating === obj2.rating
            ? obj1.dist < obj2.dist
              ? 1
              : -1
            : -1
        );
        businesses.reverse();
        console.log(businesses);
      });
      console.log(businesses.length);

      var map;
      var restMarker = new Array();
      var counter = 0;
      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: storedLat, lng: storedLong },
          zoom: 13
        });

        // Adds a marker for the user's location
        var userFlag = new google.maps.Marker({
          position: { lat: storedLat, lng: storedLong },
          map: map,
          title: "You are here.",
          icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
          }
        });

        for (var i = 0; i < businesses.length; i++) {
          var userLoc = new google.maps.Marker({
            position: {
              lat: businesses[i].lat,
              lng: businesses[i].long
            },
            map: null,
            title: `${businesses[i].name}`
          });
          restMarker.push(userLoc);
        }
        update();
      }

      function update() {
        if (!(businesses[counter].name === null)) {
          document.getElementById("name").innerHTML = businesses[counter].name;
        }
        if (!(businesses[counter].rating === null)) {
          document.getElementById("review").innerHTML =
            businesses[counter].rating;
        }
        if (!(businesses[counter].revCt === null)) {
          document.getElementById("revCt").innerHTML =
            businesses[counter].revCt;
        }
        if (!(businesses[counter].phone === null)) {
          document.getElementById("phone").innerHTML =
            businesses[counter].phone;
        }
        if (!(businesses[counter].dist === null)) {
          document.getElementById("dist").innerHTML = businesses[counter].dist;
        }
        if (!(businesses[counter].price == null)) {
          document.getElementById("price").innerHTML =
            "The price is " + businesses[counter].price + " out of $$$$.";
        }
      }

      // Updates the counter and gets the next request
      function nextRequest() {
        if (counter === restMarker.length) {
          alert("There are no more restaurants that satisfy the criteria.");
        } else {
          restMarker[counter].setMap(null);
          counter++;
          restMarker[counter].setMap(map);
          update();
        }
      }
    </script>
  </head>
  <body>
    <header id="title">
      <div class="everything">
        <h1>Restaurant Recommender</h1>
      </div>
    </header>

    <nav id="navbar">
      <div class="everything">
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="map.html">Recommendation Map</a></li>
          <li><a href="yelp.html">Yelp Display</a></li>
        </ul>
      </div>
    </nav>

    <div>
      <p>
        You have selected to use your own coordinates. Your flag is in blue. The
        restaurant flags we recommend are in red. Note that if you do not see
        the flag, you may need to adjust the map. Depending on your search
        parameters, the flag may be offscreen. If the flag is still not there,
        the restaurant may not have provided their coordinates.
      </p>
    </div>
    <!-- Displays the map -->
    <div id="map"></div>
    <div>
      <p>
        Using an equation that balances rating and the number of review, we
        recommend <span id="name">_____</span>, which has a rating of
        <span id="review">_____</span> stars based on
        <span id="revCt">_____</span> reviews. This restaurant is
        <span id="dist">_____</span> meters from you.
        <span id="price"></span> If you would like to contact them, you can at
        <span id="phone">_____</span>.
      </p>

      <p>
        Note that if there is a "______", the restaurant did not provide the
        parameter for the data.
      </p>
    </div>
    <div>
      <button onclick="nextRequest()">
        Not Satisfied? Click to Get Another Recommendation
      </button>
    </div>
  </body>
  <!-- The source for the google maps API with the key -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBq3tGjb7VKuNtNdiP6b4z_w9l60mkx6uI&callback=initMap"
    async
    defer
  ></script>
</html>
